{% extends "base.html" %}

{% block title %}Search Wine{% endblock %}

{% block head %}
<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
<style type="text/css">
	#map_canvas { height: 50%; width: 50%; }
    </style>
<script type="text/javascript"
	src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDiX6DQhbFwmwZ6SFMjCOpNhPjP--9O-o4&sensor=false">
    </script>
<script type="text/javascript">
	var map;
	var routes = [
			['55 Ridgewood Road, Ithaca, NY, 14850', '55 Ridgewood Road, Ithaca, NY, 14850',
			    ['Schwartz Performing Arts Center, Ithaca, NY 14850']],
			['Madison Square Garden, New York, NY', 'Madison Square Garden, New York, NY',
			    ['Museum of Modern Art, New York, NY']]
		     ];
	
	var currentRoute;
	var directionDisplay;
	
	function initialize() {
	    var mapOptions = {
			center: new google.maps.LatLng(34.1389397, -117.8654231),
			zoom: 9,
			mapTypeId: google.maps.MapTypeId.ROADMAP
	    };

	    map = new google.maps.Map(document.getElementById("map_canvas"),
								  mapOptions);
	    directionsPanel = document.getElementById("directionsPanel");
	}


	function renderDirections(){
	    
	    if (directionDisplay != null){
		directionDisplay.setMap(null);
		directionDisplay.setPanel(null);
	    }

	    if (currentRoute == null){
		currentRoute = 0;
	    } else {
		currentRoute = (currentRoute + 1) % routes.length;
	    }

	    originAddress = routes[currentRoute][0]
	    destinationAddress = routes[currentRoute][1]
	    stops = routes[currentRoute][2]

	    if ((originAddress == null) || (destinationAddress == null) || (stops == null)){
		return;
	    }

	    $('#num_routes').html('<b>Number of Routes: ' + routes.length + '</b>');
	    $('#curr_route').html('<b>RouteRank: ' + (currentRoute + 1) + '</b>');

	    var directionsService = new google.maps.DirectionsService();

	    var renderOptions = { draggable: true };
	    directionDisplay = new google.maps.DirectionsRenderer(renderOptions);

	    //set the directions display service to the map
	    directionDisplay.setMap(map);
	    //set the directions display panel
	    //panel is usually just and empty div.
	    //This is where the turn by turn directions appear.
	    directionDisplay.setPanel(directionsPanel);

	    //build the waypoints
	    //free api allows a max of 9 total stops including the start and end address
	    //premier allows a total of 25 stops.
	    var waypoints = [];
	    for (var i = 0; i < stops.length; i++) {
			var address = stops[i];
			if (address !== "") {
				waypoints.push({
							   location: address,
							   stopover: true
							   });
			}
	    }

	    //build directions request
	    var request = {
			origin: originAddress,
			destination: destinationAddress,
			waypoints: waypoints, //an array of waypoints
			optimizeWaypoints: false, //set to true if you want google to determine the shortest route or false to use the order specified.
			travelMode: google.maps.DirectionsTravelMode.DRIVING
		};

	    //get the route from the directions service
	    directionsService.route(request, function (response, status) {
								if (status == google.maps.DirectionsStatus.OK) {
								directionDisplay.setDirections(response);
								}
								else {
								console.log("Error calculating directions");
								}
								});
	}
	</script>

{% endblock %}

{% block content %}

<div class="container-fluid">
    <div class="row-fluid">
		<div class="span6">
			<div>
				<h1 style="position:relative;right:8%;">Search</h1>
			</div>
		</div>
    </div>
    
    <div class="row-fluid">
		<div class="span9" id="wines">
			<p class="span7 pull-left">Enter search characteristics to find your ideal wine.
			For numeric values enter a number, such as 14.0, or a range,
			such as 13.0-15.4</p></br></br><br/>
			<input class="btn btn-success pull-left" id="submit_button" value="Find My Wine" />
			<br/>
			<br/>
			<button class="btn btn-primary wine-add pull-left">Add Wine</button>
			<br/>
			<br/>
			<div class="wine pull-left">
				<h4 class="pull-left">Select Your Wine Characteristics&nbsp;&nbsp;</h4>
				<br/>
				<br/>
				<button class="btn btn-info add pull-left">Add Option</button>
				<button class="btn btn-warning wine-remove pull-left"
					style="position:relative; left:20px;">Remove Wine</button>
				<br/>
				<br/>
				<form name="input-whole" class="navbar-form pull-left">
					<p class="input-line">
					<select>
						<option name="">(Select Option)</option>
						<option name="color">Color</option>
						<option name="country">Country</option>
						<option name="percent_new_oak">Percent New Oak</option>
						<option name="percentage_alcohol">Percent Alcohol</option>
						<option name="region">Region</option>
						<option name="style">Style</option>
						<option name="vineyard">Vineyard</option>
						<option name="vintage">Vintage</option>
						<option name="wine_sub_region">Wine Subregion</option>
					</select>
					<input class="input-text" type="text">
						<button class="btn btn-small btn-danger remove">Remove</button>
						</p>
						</form>
				<br/>
				<br/>
			</div>
		</div>

		<div class="span6 pull-right" style="position: absolute; top: 100px; right: 50px;">
			<span id="num_routes"></span><span>&nbsp;&nbsp;</span>
			<span id="curr_route" style="color:green"></span><br/>
			<button class="btn btn-inverse toggle btn-small">See Another Route</button>
			<br/><br/>
			<div id="map_canvas" style="width: 550px; height: 300px"></div>
			<div id="directionsPanel" style="width: 550px;"></div>
		</div>
    </div>

</div>

<script type="text/javascript">
    $(document).ready(function(){
		initialize();
		renderDirections();
	});
   
    $(".toggle").click(function() {
		renderDirections();
    });

    $(".add").click(function() {
		firstP = $(this).siblings("form").children(":first");
		newP = firstP.clone(true)
		newP.children(".input-text").val("");
		newP.insertBefore(firstP);
		return false;
	});

    $(".wine-add").click(function() {
		firstWine = $("#wines > .wine:first");
		newWine = firstWine.clone(true);
		while (newWine.children("form").children("p").size() > 1){
			newWine.children("form").children("p:first").remove();
		}
		newWine.children("form").children("p").children(".input-text").val("");
		newWine.insertBefore(firstWine);
		return false;
	});

    $(".wine-remove").click(function(event) {
		event.preventDefault();
		if ($(this).parent().siblings(".wine").size() > 0){
			$(this).parent().remove()
		};
		return false
	});

    $(".remove").click(function(event) {
		event.preventDefault();
		if ($(this).parent().siblings().size() >= 1){
			$(this).parent().remove();
		}
		return false;
	});


	$("#submit_button").click(function(event) {
		event.preventDefault();
		var query = "?";
		//read in all user search-input parameters, iterate over wines given
		$(".wine").each(function(index, value) {
			if(index > 0) {
				query += "&";
			}
			query += "wine_num=" + index;
			//read in wine specific query parameters for wine at 'index'
			$(this).find(".input-line").each(function(ind, val) {
				var sel = $(this).find(":selected").attr("name");
				if (!(sel)){
				    alert("One of your options has no value set");
				    return;
				}
				var text = $(this).children(".input-text").val();
				if (text != "") {
					query += "&" + sel + "=" + text;
				}
			})
		})

		var uri = {% url views.calculate %} + query;
	
		$.get(uri, function(response){
			routes = response;
			currentRoute = null;
			renderDirections()
		})
	
	
		//rescript taking parameters in as JSON object.. pass through to GET request
	
	});
    
	</script>
{% endblock %}
